<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Womens Perfume</title>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" />
        <script src="https://kit.fontawesome.com/bdf5ca2238.js" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="/stylesheet/user/forher.css" />
    </head>
    <body>
        <%-include('nav3')%>
        <div class="product-heading" style="text-align: center;">
            <h2>Womens Perfume</h2>
        </div>

        <div class="product-container">
            <% products.forEach(product => { %>
                <a href="/display/<%= product.id%>">
                <div class="product-card" data-stock="<%= product.stock %>">
                    <div class="product-tumb">
                        <img src="<%= product.productImages[0] %>" alt="<%= product.name %>" />
                    </div>
                    <div class="product-details">
                        <span class="product-catagory"><%= product.category %></span>
                        <h4><a href=""><%= product.name %></a></h4>
                        <p><%= product.description %></p>
                        <div class="product-bottom-details">
                            <div class="product-price">
                                <% if (product.oldPrice) { %>
                                    <small><%= product.oldPrice %></small>
                                <% } %>
                                <%= product.price %>
                            </div>
                            <div class="product-links">
                                <span class="heart-icon" data-product-id="<%= product._id %>">
                                    <i class="fa fa-heart"></i>
                                </span>
                                <a href="#" class="addToCartIcon" data-product-id="<%= product._id %>" data-quantity="1">
                                    <i class="fa fa-shopping-cart"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div></a>
            <% }); %>
        </div>
        <%-include('about')%>
        <br>
        <%-include('footer')%>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>

        <script>
            const loggedInUser = "<%= typeof loggedInUser !== 'undefined' && loggedInUser ? loggedInUser : '' %>";

            $(document).ready(function () {
                $("#searchInput").keyup(function () {
                    var searchTerm = $(this).val().toLowerCase();
                    var productsFound = false;

                    $(".product-card").each(function () {
                        var productName = $(this).find(".product-details h4 a").text().toLowerCase();
                        if (productName.indexOf(searchTerm) > -1) {
                            $(this).show();
                            productsFound = true;
                        } else {
                            $(this).hide();
                        }
                    });

                    if (!productsFound) {
                        swal("Oops!", "No products found for your search term.", "error");
                    }
                });
            });
        </script>

        <script>
            document.querySelectorAll(".addToCartIcon").forEach(icon => {
                icon.addEventListener("click", function(event) {
                    event.preventDefault();
                    if (!loggedInUser) {
                        window.location.href = "/login";
                        return;
                    }
                    const productId = this.getAttribute("data-product-id");
                    const quantity = this.getAttribute("data-quantity");
                    const userId = "<%= typeof userId !== 'undefined' ? userId : '' %>";
                    const productCard = this.closest(".product-card");
                    const stock = productCard.getAttribute("data-stock");

                    if (parseInt(stock) <= 0) {
                        Swal.fire({
                            title: "Out of Stock",
                            text: "This product is currently out of stock.",
                            icon: "error"
                        });
                    } else {
                        const url = `/cart?productId=${productId}&quantity=${quantity}&userId=${userId}`;
                        window.location.href = url;
                    }
                });
            });
        </script>

        <script>
            document.addEventListener("DOMContentLoaded", function () {
                document.querySelectorAll(".heart-icon").forEach(function (heartIcon) {
                    heartIcon.addEventListener("click", function (event) {
                        event.preventDefault();
                        if (!loggedInUser) {
                            window.location.href = "/login";
                            return;
                        }
                        const productId = this.dataset.productId;
                        const isInWishlist = localStorage.getItem(`heart-icon-${productId}`) === "true";

                        if (isInWishlist) {
                            this.querySelector("i").classList.add("heart-icon-filled");
                        }

                        const icon = this.querySelector("i");
                        const isFilled = icon.classList.contains("heart-icon-filled");
                        const action = isFilled ? "remove" : "add";

                        icon.classList.toggle("heart-icon-filled");
                        localStorage.setItem(`heart-icon-${productId}`, !isFilled);

                        fetch(`/wishlistPage?action=${action}&productId=${productId}`, {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                        })
                            .then((response) => response.json())
                            .then((data) => {
                                if (!data.success) {
                                    icon.classList.toggle("heart-icon-filled");
                                    localStorage.setItem(`heart-icon-${productId}`, isFilled);
                                    Swal.fire({
                                        title: "Error",
                                        text: data.message || "Failed to update wishlist",
                                        icon: "error"
                                    });
                                } else {
                                    Swal.fire({
                                        title: "Success",
                                        text: `Product ${action}ed to wishlist`,
                                        icon: "success"
                                    });
                                }
                            })
                            .catch((error) => {
                                console.error("Error:", error);
                                icon.classList.toggle("heart-icon-filled");
                                localStorage.setItem(`heart-icon-${productId}`, isFilled);
                                Swal.fire({
                                    title: "Error",
                                    text: "Failed to update wishlist",
                                    icon: "error"
                                });
                            });
                    });
                });
            });
        </script>

        <script>
            function extractPrice(productElement) {
                const priceText = productElement.querySelector(".product-price").innerText.trim();
                const match = priceText.match(/â‚¹\s*([\d,.]+)/) || priceText.match(/([\d,.]+)/);
                return match ? parseFloat(match[1].replace(/,/g, '')) : 0;
            }

            function extractName(productElement) {
                return productElement.querySelector(".product-details h4 a").textContent.trim().toLowerCase();
            }

            function sortProductsByPriceLowToHigh() {
                const productContainer = document.querySelector(".product-container");
                const products = Array.from(productContainer.querySelectorAll(".product-card"));
                products.sort((a, b) => extractPrice(a) - extractPrice(b));
                productContainer.innerHTML = "";
                products.forEach((product) => productContainer.appendChild(product));
            }

            function sortProductsByPriceHighToLow() {
                const productContainer = document.querySelector(".product-container");
                const products = Array.from(productContainer.querySelectorAll(".product-card"));
                products.sort((a, b) => extractPrice(b) - extractPrice(a));
                productContainer.innerHTML = "";
                products.forEach((product) => productContainer.appendChild(product));
            }

            function sortProductsByAlphabeticalAZ() {
                const productContainer = document.querySelector(".product-container");
                const products = Array.from(productContainer.querySelectorAll(".product-card"));
                products.sort((a, b) => extractName(a).localeCompare(extractName(b)));
                productContainer.innerHTML = "";
                products.forEach((product) => productContainer.appendChild(product));
            }

            function sortProductsByAlphabeticalZA() {
                const productContainer = document.querySelector(".product-container");
                const products = Array.from(productContainer.querySelectorAll(".product-card"));
                products.sort((a, b) => extractName(b).localeCompare(extractName(a)));
                productContainer.innerHTML = "";
                products.forEach((product) => productContainer.appendChild(product));
            }

            document.addEventListener("DOMContentLoaded", function () {
                const sortPriceLowToHigh = document.querySelector("#sortByPriceLowToHigh");
                const sortPriceHighToLow = document.querySelector("#sortByPriceHighToLow");
                const sortAlphabeticalAZ = document.querySelector("#sortByAlphabeticalAZ");
                const sortAlphabeticalZA = document.querySelector("#sortByAlphabeticalZA");

                if (sortPriceLowToHigh) {
                    sortPriceLowToHigh.addEventListener("click", sortProductsByPriceLowToHigh);
                }
                if (sortPriceHighToLow) {
                    sortPriceHighToLow.addEventListener("click", sortProductsByPriceHighToLow);
                }
                if (sortAlphabeticalAZ) {
                    sortAlphabeticalAZ.addEventListener("click", sortProductsByAlphabeticalAZ);
                }
                if (sortAlphabeticalZA) {
                    sortAlphabeticalZA.addEventListener("click", sortProductsByAlphabeticalZA);
                }
            });

            const filterButton = document.getElementById("filterButton");
            if (filterButton) {
                filterButton.addEventListener("click", function () {
                    var filterMenu = document.querySelector(".filter-menu");
                    if (filterMenu) {
                        filterMenu.classList.toggle("show");
                    }
                });
            }

            window.addEventListener("click", function (event) {
                if (!event.target.matches("#filterButton")) {
                    var filterMenus = document.querySelectorAll(".filter-menu");
                    filterMenus.forEach(function (filterMenu) {
                        if (filterMenu.classList.contains("show")) {
                            filterMenu.classList.remove("show");
                        }
                    });
                }
            });
        </script>
    </body>
</html>